<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES 설비관리 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.292.0/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f9fafb; line-height: 1.6; display: flex; }

        /* Left-aligned navigation bar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            padding: 1.5rem 0;
            position: fixed;
            top: 0;
            left: 0;
        }
        .header-title {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }
        .header-title h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }
        .header-title p {
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .tab-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }
        .tab-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border: none;
            text-align: left;
        }
        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59,130,246,0.3);
        }
        .tab-btn.active .lucide {
            color: white;
        }
        .tab-btn:not(.active) {
            color: #6b7280;
        }
        .tab-btn:not(.active):hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .tab-btn.active .lucide {
            color: white;
        }

        .main-container {
            margin-left: 250px;
            width: calc(100% - 250px);
            display: flex;
            flex-direction: column;
        }
        .main-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
        }
        .user-info {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .login-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .main-content { max-width: 1280px; margin: 0 auto; padding: 2rem; width: 100%; }
        .hidden { display: none !important; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .stat-content { display: flex; align-items: center; }
        .stat-icon { width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; 
                      justify-content: center; margin-right: 1rem; }
        .stat-text p:first-child { font-size: 0.875rem; font-weight: 500; color: #6b7280; }
        .stat-text p:last-child { font-size: 1.5rem; font-weight: bold; }

        .chart-container {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        .chart-container h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
        }
        
        .form-container { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .form-header h3 { font-size: 1.125rem; font-weight: 500; color: #111827; }
        .form-content { padding: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; 
                          font-size: 0.875rem; resize: vertical; }
        .form-actions { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; 
                cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; 
                align-items: center; gap: 0.5rem; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-outline { background-color: transparent; border: 1px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background-color: #f9fafb; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        
        .table-container { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background-color: #f9fafb; padding: 0.75rem 1.5rem; text-align: left; 
                    font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; }
        .table td { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; }
        .table tbody tr:hover { background-color: #f9fafb; cursor: pointer; }
        
        .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; 
                         border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-stopped { background-color: #fee2e2; color: #991b1b; }
        .status-maintenance { background-color: #fef3c7; color: #92400e; }
        .status-idle { background-color: #dbeafe; color: #1e40af; }
        
        .search-container { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
                            padding: 1.5rem; margin-bottom: 1.5rem; }
        .search-row { display: flex; gap: 1rem; align-items: end; }
        .search-input-container { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border: 1px solid #d1d5db; 
                         border-radius: 0.375rem; font-size: 0.875rem; }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .filter-select { padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; 
                          font-size: 0.875rem; min-width: 150px; }
        
        .history-search-section { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
                                  padding: 2rem; margin-bottom: 2rem; }
        .search-form { display: flex; gap: 1rem; align-items: end; }
        .search-group { flex: 1; }
        .search-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        
        .history-card { background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; 
                         box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; overflow: hidden; }
        .history-card-header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; 
                               padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .history-card-title { font-size: 1.25rem; font-weight: bold; margin: 0; }
        .history-card-subtitle { font-size: 0.875rem; opacity: 0.9; margin-top: 0.25rem; }
        .history-card-content { display: grid; grid-template-columns: 1fr auto; gap: 2rem; padding: 2rem; }
        
        .equipment-details-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0; 
                                  border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .detail-row { display: contents; }
        .detail-label { background-color: #f8fafc; padding: 0.75rem 1rem; font-weight: 500; color: #374151; 
                        border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; }
        .detail-value { background-color: white; padding: 0.75rem 1rem; color: #111827; 
                        border-bottom: 1px solid #e5e7eb; }
        .detail-row:last-child .detail-label, .detail-row:last-child .detail-value { border-bottom: none; }
        
        .equipment-image-section { display: flex; flex-direction: column; align-items: center; gap: 1rem; min-width: 300px; }
        .equipment-image-container { display: flex; gap: 1rem; }
        .equipment-image { width: 145px; height: 100px; background-color: #f3f4f6; border: 2px solid #e5e7eb; 
                            border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; 
                            color: #6b7280; font-size: 0.75rem; }
        .qr-code-section { background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; 
                            padding: 1rem; text-align: center; width: 280px; }
        .qr-code { width: 100px; height: 100px; background-color: #f3f4f6; border: 1px solid #d1d5db; 
                    margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; 
                    font-size: 0.75rem; color: #6b7280; }
        .asset-info { font-size: 0.75rem; text-align: left; color: #374151; }
        .asset-info div { margin-bottom: 0.25rem; }
        
        .change-history-section { margin-top: 2rem; background: white; border: 1px solid #e5e7eb; 
                                  border-radius: 0.5rem; overflow: hidden; }
        .change-history-header { background-color: #f8fafc; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; 
                                 font-weight: 600; color: #111827; }
        .change-history-table { width: 100%; border-collapse: collapse; }
        .change-history-table th { background-color: #f1f5f9; padding: 0.75rem 1rem; text-align: left; 
                                    font-size: 0.875rem; font-weight: 500; color: #475569; border-bottom: 1px solid #e2e8f0; }
        .change-history-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; 
                                    font-size: 0.875rem; color: #334155; }
        .pm-badge { background-color: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; 
                    border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; }
        .calibration-badge { background-color: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; 
                              border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; }
        .fault-badge { background-color: #fee2e2; color: #dc2626; padding: 0.25rem 0.5rem; 
                        border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; }
        
        .empty-state { text-align: center; padding: 2rem; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .empty-state h3 { font-weight: 500; color: #111827; margin-bottom: 0.5rem; }
        .empty-state p { color: #6b7280; }
        
        .action-icons { display: flex; gap: 0.5rem; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; 
                      border-radius: 0.25rem; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #f3f4f6; }
        .action-btn.edit { color: #3b82f6; }
        .action-btn.delete { color: #ef4444; }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 3rem 2rem;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .file-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .file-input {
            display: none;
        }
        .upload-result {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f0f9ff;
            border: 1px solid #0284c7;
            border-radius: 0.5rem;
            color: #0369a1;
        }
        .upload-error {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #fef2f2;
            border: 1px solid #dc2626;
            border-radius: 0.5rem;
            color: #dc2626;
        }
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .template-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .fault-history-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        .fault-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        .fault-search-result {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .search-results-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .search-results-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            background-color: #ffffff;
            transition: background-color 0.15s;
        }
        .search-results-item:last-child {
            border-bottom: none;
        }
        .search-results-item:hover {
            background-color: #f3f4f6;
        }
        .search-results-item.selected {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding-left: calc(1rem - 4px);
            font-weight: 500;
        }
        .search-results-item.selected:hover {
            background-color: #dbeafe;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: normal;
        }
        .dashboard-sub-tab-nav {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .dashboard-sub-tab-btn {
            padding: 0.75rem 0.5rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            color: #6b7280;
        }
        .dashboard-sub-tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .equipment-group-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .equipment-group-card h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .equipment-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .equipment-list-item:last-child {
            border-bottom: none;
        }
        .equipment-list-item-info {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .equipment-list-item-status {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-badge.maintenance {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-badge.pm {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-badge.calibration {
            background-color: #f3e8ff;
            color: #5b21b6;
        }
        .alert-message {
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-error {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            color: #dc2626;
        }
        .date-range-search {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        .date-range-search .form-group {
            flex: 1;
        }

        .tool-management-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .selected-equipment-info {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .selected-equipment-info p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .image-preview-container {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .image-preview {
            width: 150px;
            height: 100px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #6b7280;
            font-size: 0.75rem;
            overflow: hidden;
            position: relative;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spare-part-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: black;
            text-decoration: none;
        }
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
        }
        
        .part-master-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            justify-content: flex-end;
        }

        .spare-part-master-tab .form-container .form-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .spare-part-master-tab .form-container .form-content {
                grid-template-columns: 1fr 2fr;
            }
        }
        
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .search-row { flex-direction: column; align-items: stretch; }
            .tab-nav { gap: 1rem; }
            .history-card-content { grid-template-columns: 1fr; gap: 1rem; }
            .equipment-details-grid { grid-template-columns: 1fr; }
            .equipment-image-section { min-width: auto; }
            .equipment-image-container { flex-direction: column; }
            .equipment-image, .qr-code-section { width: 100%; }
            .search-form { flex-direction: column; }
            .date-range-search { flex-direction: column; align-items: stretch; }
            .spare-part-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="header-title">
            <h1>MES 설비관리</h1>
            <p>Equipment Management</p>
        </div>
        <div class="tab-nav">
            <button class="tab-btn active" id="tab-dashboard" onclick="showTab('dashboard')">
                <i data-lucide="layout-dashboard"></i>
                <span>설비 현황</span>
            </button>
            <button class="tab-btn" id="tab-process" onclick="showTab('process')">
                <i data-lucide="factory"></i>
                <span>공정 관리</span>
            </button>
            <button class="tab-btn" id="tab-fault-status" onclick="showTab('fault-status')">
                <i data-lucide="circle-alert"></i>
                <span>고장 발생 현황</span>
            </button>
            <button class="tab-btn" id="tab-register" onclick="showTab('register')">
                <i data-lucide="plus-circle"></i>
                <span>설비 등록</span>
            </button>
            <button class="tab-btn" id="tab-list" onclick="showTab('list')">
                <i data-lucide="clipboard-list"></i>
                <span>설비 조회</span>
            </button>
            <button class="tab-btn" id="tab-spare-part-master" onclick="showTab('spare-part-master')">
                <i data-lucide="gear"></i>
                <span>스페어 파트 마스터</span>
            </button>
            <button class="tab-btn" id="tab-spare-parts" onclick="showTab('spare-parts')">
                <i data-lucide="wrench"></i>
                <span>스페어 파트 재고</span>
            </button>
            <button class="tab-btn" id="tab-fault-history" onclick="showTab('fault-history')">
                <i data-lucide="file-edit"></i>
                <span>히스토리 등록</span>
            </button>
            <button class="tab-btn" id="tab-history" onclick="showTab('history')">
                <i data-lucide="notebook-text"></i>
                <span>설비 이력</span>
            </button>
            <button class="tab-btn" id="tab-bulk" onclick="showTab('bulk')">
                <i data-lucide="folder-up"></i>
                <span>일괄 등록</span>
            </button>
            <button class="tab-btn" id="tab-logs" onclick="showTab('logs')">
                <i data-lucide="list-checks"></i>
                <span>로그 확인</span>
            </button>
        </div>
    </div>
    <div class="main-container">
        <div class="main-header">
            <div class="user-info">
                <i data-lucide="user" style="width: 1.25rem; height: 1.25rem;"></i>
                <select id="user-selector" class="login-select" onchange="changeUser(this.value)">
                    <option value="admin">관리자 (admin)</option>
                    <option value="operator">담당자 (operator)</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                <i data-lucide="refresh-cw"></i>
                <span>실시간 업데이트</span>
            </div>
        </div>

        <div class="main-content">
            <div id="dashboard-tab" class="tab-content">
                <div class="stats-grid" id="stats-grid"></div>
                <div class="chart-container" style="margin-top: 2rem;">
                    <h3>설비 가동 현황</h3>
                    <div style="width: 100%; max-width: 800px; margin: 0 auto;">
                        <canvas id="status-chart"></canvas>
                    </div>
                </div>
                <div class="dashboard-sub-tab-nav">
                    <button class="dashboard-sub-tab-btn active" onclick="showDashboardSubTab('all')">전체</button>
                    <button class="dashboard-sub-tab-btn" onclick="showDashboardSubTab('active')">가동</button>
                    <button class="dashboard-sub-tab-btn" onclick="showDashboardSubTab('stopped')">비가동</button>
                    <button class="dashboard-sub-tab-btn" onclick="showDashboardSubTab('maintenance')">고장</button>
                    <button class="dashboard-sub-tab-btn" onclick="showDashboardSubTab('idle')">유휴</button>
                </div>
                <div id="dashboard-equipment-list"></div>
            </div>

            <div id="process-tab" class="tab-content hidden">
                <div class="form-container">
                    <div class="form-header"><h3>공정별 설비 현황</h3></div>
                    <div class="form-content">
                        <div id="process-equipment-list"></div>
                    </div>
                </div>
            </div>

            <div id="fault-status-tab" class="tab-content hidden">
                <div class="date-range-search">
                    <div class="form-group">
                        <label for="fault-start-date">시작일</label>
                        <input type="date" id="fault-start-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="fault-end-date">종료일</label>
                        <input type="date" id="fault-end-date" class="form-input">
                    </div>
                    <button class="btn btn-primary" onclick="searchFaultHistoryByDate()">
                        <i data-lucide="search" style="width: 1rem; height: 1rem;"></i>
                        <span>조회</span>
                    </button>
                </div>
                <div class="table-container">
                    <div class="form-header">
                        <h3>고장 발생 목록 (<span id="fault-list-count">0</span>건)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>설비명 (Asset Code)</th>
                                    <th>발생 시간</th>
                                    <th>종료 시간</th>
                                    <th>담당자</th>
                                    <th>내용</th>
                                    <th>유형</th>
                                    <th>사용한 부품</th>
                                </tr>
                            </thead>
                            <tbody id="fault-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="register-tab" class="tab-content hidden">
                <div class="form-container">
                    <div class="form-header"><h3 id="form-title">새 설비 등록</h3></div>
                    <div class="form-content">
                        <form id="equipment-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>설비명 *</label>
                                    <input type="text" id="assetName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>Asset Code *</label>
                                    <input type="text" id="assetCode" class="form-input" required>
                                    <div id="assetCode-alert" class="alert-message alert-error hidden">
                                        <i data-lucide="alert-circle" style="width: 1rem; height: 1rem;"></i>
                                        <span>이미 등록된 Asset Code입니다.</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>S/N *</label>
                                    <input type="text" id="serialNumber" class="form-input" required>
                                    <div id="serialNumber-alert" class="alert-message alert-error hidden">
                                        <i data-lucide="alert-circle" style="width: 1rem; height: 1rem;"></i>
                                        <span>이미 등록된 S/N입니다.</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>설비 모델명</label>
                                    <input type="text" id="mcModel" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>설비 제조사</label>
                                    <input type="text" id="manufacturer" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>공정 *</label>
                                    <select id="process" class="form-input" required>
                                        <option value="">-- 공정 선택 --</option>
                                        <option value="SMT">SMT 공정</option>
                                        <option value="Underfill">Underfill 공정</option>
                                        <option value="SAW">SAW 공정</option>
                                        <option value="MOLD">MOLD 공정</option>
                                        <option value="Laser">Laser 공정</option>
                                        <option value="Bending">Bending 공정</option>
                                        <option value="TEST">TEST 공정</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>생산 제품 모델명</label>
                                    <input type="text" id="productModel" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>공장 *</label>
                                    <input type="text" id="factory" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>층 *</label>
                                    <input type="text" id="floor" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>설비 입고일 *</label>
                                    <input type="date" id="installDate" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>가동 상태 *</label>
                                    <select id="operatingStatus" class="form-input" required>
                                        <option value="active">가동</option>
                                        <option value="stopped">비가동</option>
                                        <option value="maintenance">고장</option>
                                        <option value="idle">유휴</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>담당자</label>
                                    <input type="text" id="operator" class="form-input">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>설비 사진 (정면 & 명판)</label>
                                    <div style="display: flex; gap: 1rem;">
                                        <input type="file" id="frontImage" class="form-input" style="flex: 1;" accept="image/jpeg, image/png">
                                        <input type="file" id="nameplateImage" class="form-input" style="flex: 1;" accept="image/jpeg, image/png">
                                    </div>
                                    <div class="image-preview-container">
                                        <div class="image-preview" id="front-image-preview">
                                            정면 사진
                                        </div>
                                        <div class="image-preview" id="nameplate-image-preview">
                                            명판 사진
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="reset" class="btn btn-outline">초기화</button>
                                <button type="submit" class="btn btn-success" id="form-submit-btn">
                                    <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
                                    <span id="form-submit-text">등록</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="list-tab" class="tab-content hidden">
                <div class="search-container">
                    <div class="search-row">
                        <div class="search-input-container">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" id="list-search-input" class="search-input" placeholder="설비명, Asset Code, S/N, 제조사 검색">
                        </div>
                        <select id="list-filter-status" class="filter-select" onchange="renderEquipmentList()">
                            <option value="all">전체 상태</option>
                            <option value="active">가동</option>
                            <option value="stopped">비가동</option>
                            <option value="maintenance">고장</option>
                            <option value="idle">유휴</option>
                        </select>
                        <select id="list-filter-process" class="filter-select" onchange="renderEquipmentList()">
                            <option value="all">전체 공정</option>
                            <option value="SMT">SMT 공정</option>
                            <option value="Underfill">Underfill 공정</option>
                            <option value="SAW">SAW 공정</option>
                            <option value="MOLD">MOLD 공정</option>
                            <option value="Laser">Laser 공정</option>
                            <option value="Bending">Bending 공정</option>
                            <option value="TEST">TEST 공정</option>
                        </select>
                        <button class="btn btn-primary" onclick="renderEquipmentList()">
                            <i data-lucide="search" style="width: 1rem; height: 1rem;"></i>
                            <span>조회</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>설비명</th>
                                    <th>Asset Code</th>
                                    <th>S/N</th>
                                    <th>설비 제조사</th>
                                    <th>공정</th>
                                    <th>가동 상태</th>
                                    <th>담당자</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="equipment-list-table-body">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="selected-equipment-details" class="hidden">
                    <div class="tool-management-section">
                        <div class="selected-equipment-info" id="tool-equipment-info"></div>
                        <h3>툴 등록 및 관리</h3>
                        <form id="tool-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>툴 이름 *</label>
                                    <input type="text" id="tool-name" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>툴 수명 (총 가공 횟수) *</label>
                                    <input type="number" id="tool-lifetime" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>담당자</label>
                                    <input type="text" id="tool-operator" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>등록일</label>
                                    <input type="date" id="tool-reg-date" class="form-input">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i data-lucide="plus" style="width: 1rem; height: 1rem;"></i>
                                    <span>툴 등록</span>
                                </button>
                            </div>
                        </form>
                        <div style="margin-top: 1.5rem;">
                            <h3>등록된 툴 목록</h3>
                            <div class="table-container" style="margin-top: 1rem;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>툴 이름</th>
                                            <th>사용 횟수</th>
                                            <th>수명</th>
                                            <th>상태</th>
                                            <th>담당자</th>
                                            <th>작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tool-list-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="spare-part-master-tab" class="tab-content hidden">
                <div class="form-container">
                    <div class="form-content">
                        <form id="spare-part-master-form">
                            <h3 id="part-master-form-title">스페어 파트 기초 정보 등록</h3>
                            <div class="form-grid" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label>공정 *</label>
                                    <select id="part-master-process" class="form-input" required>
                                        <option value="">-- 공정 선택 --</option>
                                        <option value="SMT">SMT 공정</option>
                                        <option value="Underfill">Underfill 공정</option>
                                        <option value="SAW">SAW 공정</option>
                                        <option value="MOLD">MOLD 공정</option>
                                        <option value="Laser">Laser 공정</option>
                                        <option value="Bending">Bending 공정</option>
                                        <option value="TEST">TEST 공정</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>파트명 *</label>
                                    <input type="text" id="part-master-name" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>파트 스펙</label>
                                    <input type="text" id="part-master-spec" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>제조사</label>
                                    <input type="text" id="part-master-manufacturer" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>사용 설비명</label>
                                    <select id="part-master-equipment" class="form-input">
                                        <option value="">-- 설비 선택 --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="reset" class="btn btn-outline" onclick="resetPartMasterForm()">초기화</button>
                                <button type="submit" class="btn btn-success" id="part-master-submit-btn">
                                    <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
                                    <span>등록</span>
                                </button>
                            </div>
                        </form>
                        <div class="table-container">
                            <div class="form-header">
                                <h3>스페어 파트 마스터 목록</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>공정</th>
                                            <th>파트명</th>
                                            <th>파트 스펙</th>
                                            <th>제조사</th>
                                            <th>사용 설비명</th>
                                            <th>작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="spare-part-master-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="spare-parts-tab" class="tab-content hidden">
                <div class="search-container">
                    <div class="search-row">
                        <div class="search-input-container">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" id="part-search-input" class="search-input" placeholder="부품명, 파트 코드 검색">
                        </div>
                        <button class="btn btn-primary" onclick="renderSparePartsList()">
                            <i data-lucide="search" style="width: 1rem; height: 1rem;"></i>
                            <span>조회</span>
                        </button>
                    </div>
                </div>
                <div class="spare-part-controls">
                    <button class="btn btn-success" onclick="showPartModal('inbound')">
                        <i data-lucide="plus" style="width: 1rem; height: 1rem;"></i>
                        <span>입고 등록</span>
                    </button>
                    <button class="btn btn-danger" onclick="showPartModal('outbound')">
                        <i data-lucide="minus" style="width: 1rem; height: 1rem;"></i>
                        <span>출고 등록</span>
                    </button>
                </div>
                <div class="table-container">
                    <div class="form-header">
                        <h3>스페어 파트 재고 현황</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>부품명</th>
                                    <th>파트 코드</th>
                                    <th>사용 공정</th>
                                    <th>현재 재고</th>
                                    <th>최소 재고</th>
                                    <th>최대 재고</th>
                                    <th>재고 상태</th>
                                </tr>
                            </thead>
                            <tbody id="spare-part-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="fault-history-tab" class="tab-content hidden">
                <div class="fault-history-section">
                    <h3>유지보수 히스토리 등록</h3>
                    <div class="search-form" style="margin-top: 1rem;">
                        <div class="search-group" style="flex: 2;">
                            <label for="fault-equipment-search">설비명, Asset Code 검색</label>
                            <input type="text" id="fault-equipment-search" class="form-input" placeholder="설비명, Asset Code를 입력하세요">
                            <ul id="fault-equipment-search-results" class="search-results-list hidden"></ul>
                        </div>
                        <div class="search-group" style="flex: 1;">
                            <label for="fault-equipment-select">선택된 설비</label>
                            <input type="text" id="fault-equipment-select" class="form-input" readonly>
                        </div>
                    </div>
                    <form id="fault-history-form" style="margin-top: 1.5rem;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="maintenance-type">유지보수 유형 *</label>
                                <select id="maintenance-type" class="form-input" required>
                                    <option value="fault">고장</option>
                                    <option value="pm">PM (월간점검)</option>
                                    <option value="calibration">Calibration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fault-occur-time">시작 시간</label>
                                <input type="datetime-local" id="fault-occur-time" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="fault-end-time">종료 시간</label>
                                <input type="datetime-local" id="fault-end-time" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="fault-type">상세 내용 (고장/점검 유형)</label>
                                <input type="text" id="fault-type" class="form-input" placeholder="예: 센서 불량, 정기 점검, 영점 조정">
                            </div>
                            <div class="form-group">
                                <label for="fault-reporter">담당자</label>
                                <input type="text" id="fault-reporter" class="form-input">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="fault-description">상세 내용 및 조치 사항</label>
                                <textarea id="fault-description" class="form-textarea" rows="4"></textarea>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="fault-parts-used">사용한 스페어 파트 (부품명, 수량)</label>
                                <input type="text" id="fault-parts-used" class="form-input" placeholder="예: '베어링 2개, 실린더 1개'">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
                                <span>히스토리 저장</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="history-tab" class="tab-content hidden">
                <div class="history-search-section">
                    <form class="search-form">
                        <div class="search-group" style="flex: 2;">
                            <label for="history-equipment-search">설비명, Asset Code 검색</label>
                            <input type="text" id="history-equipment-search" class="form-input" placeholder="설비명, Asset Code를 입력하세요">
                            <ul id="history-equipment-search-results" class="search-results-list hidden"></ul>
                        </div>
                        <div class="search-group" style="flex: 1;">
                            <label for="history-equipment-select">선택된 설비</label>
                            <input type="text" id="history-equipment-select" class="form-input" readonly>
                        </div>
                        <div class="search-group">
                            <button type="button" class="btn btn-primary" onclick="showEquipmentHistory()">
                                <i data-lucide="search" style="width: 1rem; height: 1rem;"></i>
                                <span>이력 조회</span>
                            </button>
                        </div>
                    </form>
                </div>
                <div id="history-card-container">
                    
                </div>
            </div>

            <div id="bulk-tab" class="tab-content hidden">
                <div class="template-section">
                    <h3>샘플 템플릿 다운로드</h3>
                    <p style="margin-bottom: 1rem; color: #6b7280;">아래 템플릿을 다운로드하여 설비 정보를 작성한 후 업로드해주세요.</p>
                    <button class="btn btn-primary" onclick="downloadTemplate()">
                        <i data-lucide="download" style="width: 1rem; height: 1rem;"></i>
                        <span>설비 등록 템플릿 다운로드</span>
                    </button>
                </div>
                <div class="form-container">
                    <div class="form-header">
                        <h3>설비 정보 일괄 등록</h3>
                    </div>
                    <div class="form-content">
                        <div id="file-upload-area" class="file-upload-area">
                            <i data-lucide="file-up" style="width: 2.5rem; height: 2.5rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
                            <p style="font-size: 1.125rem; font-weight: 500; color: #4b5563;">여기에 파일을 끌어다 놓거나 클릭하여 업로드하세요.</p>
                            <p style="font-size: 0.875rem; color: #9ca3af;">지원 파일 형식: .xlsx</p>
                            <input type="file" id="excel-file-input" class="file-input" accept=".xlsx">
                        </div>
                        <div id="upload-message" class="hidden"></div>
                        <div id="preview-container" class="preview-table hidden">
                            <table class="table">
                                <thead id="preview-header"></thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                        <div id="bulk-upload-actions" class="form-actions hidden">
                            <button class="btn btn-primary" onclick="processBulkUpload()">
                                <i data-lucide="upload" style="width: 1rem; height: 1rem;"></i>
                                <span>일괄 등록</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="logs-tab" class="tab-content hidden">
                <div class="table-container">
                    <div class="form-header">
                        <h3>시스템 로그</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>사용자</th>
                                    <th>액션</th>
                                    <th>대상</th>
                                    <th>상세 내용</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="part-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="part-modal-title"></h3>
                <span class="close-btn" onclick="closePartModal()">&times;</span>
            </div>
            <form id="part-transaction-form">
                <input type="hidden" id="transaction-type">
                <div class="form-group">
                    <label>파트 코드</label>
                    <select id="part-id" class="form-select" required onchange="updatePartName()">
                        <option value="">-- 파트 선택 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>부품명</label>
                    <input type="text" id="part-name" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label>수량 *</label>
                    <input type="number" id="part-quantity" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label>공정 *</label>
                    <select id="part-process" class="form-select" required onchange="filterEquipmentsByProcess()">
                        <option value="">-- 공정 선택 --</option>
                        <option value="SMT">SMT 공정</option>
                        <option value="Underfill">Underfill 공정</option>
                        <option value="SAW">SAW 공정</option>
                        <option value="MOLD">MOLD 공정</option>
                        <option value="Laser">Laser 공정</option>
                        <option value="Bending">Bending 공정</option>
                        <option value="TEST">TEST 공정</option>
                    </select>
                </div>
                <div class="form-group" id="used-equipment-group">
                    <label>사용 설비</label>
                    <select id="used-equipment" class="form-select">
                        <option value="">-- 설비 선택 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>담당자</label>
                    <input type="text" id="part-operator" class="form-input">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
                        <span>등록</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('installDate').value = today;
            
            // 초기 렌더링
            loadData();
            renderDashboard();
            renderEquipmentList();
            renderSparePartsList();
            renderSparePartMasters();
            renderLogs();
            setupEventListeners();
        });

        // ==================== 데이터 모델 ====================
        let equipments = JSON.parse(localStorage.getItem('equipments')) || [
            { id: 'eq001', assetName: 'SMT Mounter 1', assetCode: 'SMT-001', serialNumber: 'SN-001', mcModel: 'Fuji NXT III', manufacturer: 'Fuji', process: 'SMT', productModel: 'iPhone 15', factory: '1공장', floor: '1층', installDate: '2022-01-01', operatingStatus: 'active', operator: '김철수', frontImage: null, nameplateImage: null, pmHistory: [], faultHistory: [], tools: [] },
            { id: 'eq002', assetName: 'Reflow Oven 1', assetCode: 'REFLOW-001', serialNumber: 'SN-002', mcModel: 'Rehm V8', manufacturer: 'Rehm', process: 'SMT', productModel: 'iPhone 15', factory: '1공장', floor: '1층', installDate: '2022-01-05', operatingStatus: 'maintenance', operator: '박영희', frontImage: null, nameplateImage: null, pmHistory: [], faultHistory: [], tools: [] },
            { id: 'eq003', assetName: 'Laser Cutter 1', assetCode: 'LASER-001', serialNumber: 'SN-003', mcModel: 'TRUMPF TruLaser', manufacturer: 'TRUMPF', process: 'Laser', productModel: 'iPhone 15', factory: '2공장', floor: '2층', installDate: '2023-03-10', operatingStatus: 'stopped', operator: '김철수', frontImage: null, nameplateImage: null, pmHistory: [], faultHistory: [], tools: [] },
            { id: 'eq004', assetName: 'TEST Handler 1', assetCode: 'TEST-001', serialNumber: 'SN-004', mcModel: 'Test Pro', manufacturer: 'Probing', process: 'TEST', productModel: 'Galaxy S25', factory: '3공장', floor: '1층', installDate: '2024-05-20', operatingStatus: 'idle', operator: '이영희', frontImage: null, nameplateImage: null, pmHistory: [], faultHistory: [], tools: [] },
        ];
        let logs = JSON.parse(localStorage.getItem('logs')) || [];
        let spareParts = JSON.parse(localStorage.getItem('spareParts')) || [
            { partCode: 'PN-SMT-01', partName: '노즐 221', process: 'SMT', currentStock: 15, minStock: 10, maxStock: 30 },
            { partCode: 'PN-SMT-02', partName: '노즐 222', process: 'SMT', currentStock: 8, minStock: 10, maxStock: 30 },
            { partCode: 'PN-LASER-01', partName: '레이저 헤드', process: 'Laser', currentStock: 2, minStock: 1, maxStock: 5 },
            { partCode: 'PN-TEST-01', partName: '프로브 카드', process: 'TEST', currentStock: 5, minStock: 5, maxStock: 15 },
        ];
        let sparePartMasters = JSON.parse(localStorage.getItem('sparePartMasters')) || [
            { id: 'spm001', process: 'SMT', partName: '노즐 221', partSpec: '5mm', manufacturer: 'Fuji', usedEquipment: 'SMT-001' },
            { id: 'spm002', process: 'SMT', partName: '노즐 222', partSpec: '6mm', manufacturer: 'Fuji', usedEquipment: 'SMT-001' },
            { id: 'spm003', process: 'Laser', partName: '레이저 헤드', partSpec: '40W', manufacturer: 'TRUMPF', usedEquipment: 'LASER-001' }
        ];
        let partHistory = JSON.parse(localStorage.getItem('partHistory')) || [];
        let selectedEquipment = null;
        let currentUser = 'admin';
        const processes = ['SMT', 'Underfill', 'SAW', 'MOLD', 'Laser', 'Bending', 'TEST'];

        // ==================== 데이터 관리 함수 ====================
        function loadData() {
            equipments = JSON.parse(localStorage.getItem('equipments')) || equipments;
            logs = JSON.parse(localStorage.getItem('logs')) || logs;
            spareParts = JSON.parse(localStorage.getItem('spareParts')) || spareParts;
            sparePartMasters = JSON.parse(localStorage.getItem('sparePartMasters')) || sparePartMasters;
            partHistory = JSON.parse(localStorage.getItem('partHistory')) || partHistory;
        }

        function saveData() {
            localStorage.setItem('equipments', JSON.stringify(equipments));
            localStorage.setItem('logs', JSON.stringify(logs));
            localStorage.setItem('spareParts', JSON.stringify(spareParts));
            localStorage.setItem('sparePartMasters', JSON.stringify(sparePartMasters));
            localStorage.setItem('partHistory', JSON.stringify(partHistory));
        }

        function addLog(action, target, details) {
            logs.unshift({
                timestamp: new Date().toLocaleString(),
                user: currentUser,
                action: action,
                target: target,
                details: details
            });
            saveData();
            renderLogs();
        }

        function getEquipmentStatusText(status) {
            switch (status) {
                case 'active': return '가동';
                case 'stopped': return '비가동';
                case 'maintenance': return '고장';
                case 'idle': return '유휴';
            }
        }
        
        function getMaintenanceTypeText(type) {
            switch (type) {
                case 'fault': return '고장';
                case 'pm': return 'PM';
                case 'calibration': return 'Calibration';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'status-active';
                case 'stopped': return 'status-stopped';
                case 'maintenance': return 'status-maintenance';
                case 'idle': return 'status-idle';
            }
        }
        
        function getMaintenanceBadgeClass(type) {
            switch (type) {
                case 'fault': return 'fault-badge';
                case 'pm': return 'pm-badge';
                case 'calibration': return 'calibration-badge';
            }
        }

        // ==================== UI 렌더링 함수 ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId + '-tab').classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            // 탭별 초기화
            if (tabId === 'dashboard') {
                renderDashboard();
                showDashboardSubTab('all');
            } else if (tabId === 'list') {
                renderEquipmentList();
            } else if (tabId === 'history') {
                document.getElementById('history-card-container').innerHTML = '';
            } else if (tabId === 'spare-parts') {
                renderSparePartsList();
            } else if (tabId === 'spare-part-master') {
                renderSparePartMasters();
                populateEquipmentSelect();
            } else if (tabId === 'process') {
                renderProcessTab();
            }
        }

        // 대시보드 렌더링
        function renderDashboard() {
            const total = equipments.length;
            const active = equipments.filter(e => e.operatingStatus === 'active').length;
            const stopped = equipments.filter(e => e.operatingStatus === 'stopped').length;
            const maintenance = equipments.filter(e => e.operatingStatus === 'maintenance').length;
            const idle = equipments.filter(e => e.operatingStatus === 'idle').length;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon" style="background-color: #e0e7ff; color: #4338ca;"><i data-lucide="package"></i></div>
                        <div class="stat-text"><p>전체 설비</p><p>${total}</p></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon" style="background-color: #d1fae5; color: #059669;"><i data-lucide="play"></i></div>
                        <div class="stat-text"><p>가동 중</p><p>${active}</p></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon" style="background-color: #fee2e2; color: #ef4444;"><i data-lucide="pause"></i></div>
                        <div class="stat-text"><p>비가동</p><p>${stopped}</p></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon" style="background-color: #fef3c7; color: #d97706;"><i data-lucide="wrench"></i></div>
                        <div class="stat-text"><p>고장</p><p>${maintenance}</p></div>
                    </div>
                </div>
            `;
            document.getElementById('stats-grid').innerHTML = statsHtml;
            lucide.createIcons();
            
            const ctx = document.getElementById('status-chart').getContext('2d');
            if (window.statusChart) window.statusChart.destroy();
            window.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['가동', '비가동', '고장', '유휴'],
                    datasets: [{
                        data: [active, stopped, maintenance, idle],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showDashboardSubTab(status) {
            document.querySelectorAll('.dashboard-sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.dashboard-sub-tab-btn[onclick="showDashboardSubTab('${status}')"]`).classList.add('active');

            const filteredEquipments = status === 'all' ? equipments : equipments.filter(e => e.operatingStatus === status);
            let html = '';
            const groupedByProcess = filteredEquipments.reduce((acc, eq) => {
                (acc[eq.process] = acc[eq.process] || []).push(eq);
                return acc;
            }, {});

            for (const process in groupedByProcess) {
                html += `<div class="equipment-group-card">
                            <h4>${process} 공정</h4>
                            ${groupedByProcess[process].map(eq => `
                                <div class="equipment-list-item">
                                    <div class="equipment-list-item-info">${eq.assetName} (${eq.assetCode})</div>
                                    <span class="status-badge ${getStatusBadgeClass(eq.operatingStatus)}">
                                        ${getEquipmentStatusText(eq.operatingStatus)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>`;
            }

            document.getElementById('dashboard-equipment-list').innerHTML = html || `<div class="empty-state">
                                                                                        <span class="empty-state-icon">🤖</span>
                                                                                        <h3>해당하는 설비가 없습니다.</h3>
                                                                                        <p>다른 조건을 선택하거나 설비를 등록해 주세요.</p>
                                                                                    </div>`;
            lucide.createIcons();
        }

        function renderProcessTab() {
            const groupedByProcess = equipments.reduce((acc, eq) => {
                (acc[eq.process] = acc[eq.process] || []).push(eq);
                return acc;
            }, {});

            let html = '';
            processes.forEach(process => {
                const processEquipments = groupedByProcess[process] || [];
                const statusCounts = processEquipments.reduce((counts, eq) => {
                    counts[eq.operatingStatus] = (counts[eq.operatingStatus] || 0) + 1;
                    return counts;
                }, {});

                html += `<div class="equipment-group-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4>${process} 공정</h4>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                                    <span>총 설비: ${processEquipments.length}대</span>
                                    ${Object.entries(statusCounts).map(([status, count]) => `
                                        <span class="status-badge ${getStatusBadgeClass(status)}">${getEquipmentStatusText(status)}: ${count}</span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>설비명 (Asset Code)</th>
                                            <th>설비 제조사</th>
                                            <th>가동 상태</th>
                                            <th>담당자</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${processEquipments.length > 0 ? processEquipments.map(eq => `
                                            <tr>
                                                <td><a href="#" onclick="showEquipmentHistoryById('${eq.id}')">${eq.assetName} (${eq.assetCode})</a></td>
                                                <td>${eq.manufacturer || 'N/A'}</td>
                                                <td><span class="status-badge ${getStatusBadgeClass(eq.operatingStatus)}">${getEquipmentStatusText(eq.operatingStatus)}</span></td>
                                                <td>${eq.operator || 'N/A'}</td>
                                            </tr>
                                        `).join('') : `
                                            <tr><td colspan="4" style="text-align: center; color: #6b7280;">등록된 설비가 없습니다.</td></tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
            });
            document.getElementById('process-equipment-list').innerHTML = html;
            lucide.createIcons();
        }

        function renderEquipmentList() {
            const searchTerm = document.getElementById('list-search-input').value.toLowerCase();
            const filterStatus = document.getElementById('list-filter-status').value;
            const filterProcess = document.getElementById('list-filter-process').value;

            const filteredEquipments = equipments.filter(eq => {
                const matchesSearch = searchTerm === '' || 
                                      eq.assetName.toLowerCase().includes(searchTerm) ||
                                      eq.assetCode.toLowerCase().includes(searchTerm) ||
                                      eq.serialNumber.toLowerCase().includes(searchTerm) ||
                                      eq.manufacturer.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || eq.operatingStatus === filterStatus;
                const matchesProcess = filterProcess === 'all' || eq.process === filterProcess;
                return matchesSearch && matchesStatus && matchesProcess;
            });

            const tableBody = document.getElementById('equipment-list-table-body');
            tableBody.innerHTML = filteredEquipments.map(eq => `
                <tr onclick="selectEquipment('${eq.id}')">
                    <td>${eq.assetName}</td>
                    <td>${eq.assetCode}</td>
                    <td>${eq.serialNumber}</td>
                    <td>${eq.manufacturer || 'N/A'}</td>
                    <td>${eq.process}</td>
                    <td><span class="status-badge ${getStatusBadgeClass(eq.operatingStatus)}">${getEquipmentStatusText(eq.operatingStatus)}</span></td>
                    <td>${eq.operator || 'N/A'}</td>
                    <td class="action-icons">
                        <select onchange="updateEquipmentStatus('${eq.id}', this.value)" class="form-input" style="width: auto;">
                            <option value="">상태변경</option>
                            <option value="active">가동</option>
                            <option value="stopped">비가동</option>
                            <option value="maintenance">고장</option>
                            <option value="idle">유휴</option>
                        </select>
                        <button class="action-btn edit" onclick="event.stopPropagation(); editEquipment('${eq.id}')"><i data-lucide="pencil"></i></button>
                        <button class="action-btn delete" onclick="event.stopPropagation(); deleteEquipment('${eq.id}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        
        function updateEquipmentStatus(id, newStatus) {
            if (!newStatus) return;
            const equipment = equipments.find(eq => eq.id === id);
            const oldStatus = equipment.operatingStatus;
            equipment.operatingStatus = newStatus;
            saveData();
            addLog('설비 상태 변경', equipment.assetName, `상태가 "${getEquipmentStatusText(oldStatus)}"에서 "${getEquipmentStatusText(newStatus)}"로 변경되었습니다.`);
            renderEquipmentList();
        }

        let selectedEquipmentId = null;

        function selectEquipment(id) {
            selectedEquipmentId = id;
            const selectedEq = equipments.find(eq => eq.id === id);
            
            document.querySelectorAll('#equipment-list-table-body tr').forEach(row => {
                row.classList.remove('selected');
            });
            document.querySelector(`#equipment-list-table-body tr[onclick="selectEquipment('${id}')"]`).classList.add('selected');

            const toolInfoHtml = `
                <p><strong>설비명:</strong> ${selectedEq.assetName} (${selectedEq.assetCode})</p>
                <p><strong>공정:</strong> ${selectedEq.process}</p>
            `;
            document.getElementById('tool-equipment-info').innerHTML = toolInfoHtml;
            document.getElementById('selected-equipment-details').classList.remove('hidden');
            renderToolList();
        }

        function renderToolList() {
            const selectedEq = equipments.find(eq => eq.id === selectedEquipmentId);
            const toolListBody = document.getElementById('tool-list-table-body');
            toolListBody.innerHTML = '';
            
            if (!selectedEq || !selectedEq.tools || selectedEq.tools.length === 0) {
                toolListBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6b7280;">등록된 툴이 없습니다.</td></tr>`;
                return;
            }

            selectedEq.tools.forEach(tool => {
                const remainingLife = tool.lifetime - tool.usageCount;
                const status = remainingLife <= 0 ? '교체 필요' : `${remainingLife}회 남음`;
                const statusClass = remainingLife <= 0 ? 'status-stopped' : 'status-active';

                const row = `
                    <tr>
                        <td>${tool.name}</td>
                        <td>${tool.usageCount}</td>
                        <td>${tool.lifetime}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>${tool.operator}</td>
                        <td class="action-icons">
                            <button class="btn btn-warning" onclick="event.stopPropagation(); updateToolUsage('${selectedEq.id}', '${tool.id}')">사용</button>
                            <button class="action-btn delete" onclick="event.stopPropagation(); deleteTool('${selectedEq.id}', '${tool.id}')"><i data-lucide="trash-2"></i></button>
                        </td>
                    </tr>
                `;
                toolListBody.innerHTML += row;
            });
            lucide.createIcons();
        }

        document.getElementById('tool-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('tool-name').value;
            const lifetime = parseInt(document.getElementById('tool-lifetime').value);
            const operator = document.getElementById('tool-operator').value;
            const regDate = document.getElementById('tool-reg-date').value;

            if (selectedEquipmentId) {
                const selectedEq = equipments.find(eq => eq.id === selectedEquipmentId);
                const newTool = {
                    id: 'tool-' + Date.now(),
                    name,
                    lifetime,
                    usageCount: 0,
                    operator,
                    regDate
                };
                selectedEq.tools.push(newTool);
                saveData();
                renderToolList();
                addLog('툴 등록', selectedEq.assetName, `툴 "${name}" 등록 (수명: ${lifetime}회)`);
                document.getElementById('tool-form').reset();
            }
        });

        function updateToolUsage(eqId, toolId) {
            const selectedEq = equipments.find(eq => eq.id === eqId);
            const tool = selectedEq.tools.find(t => t.id === toolId);
            if (tool) {
                tool.usageCount++;
                saveData();
                renderToolList();
                addLog('툴 사용', selectedEq.assetName, `툴 "${tool.name}" 사용 횟수 1회 증가`);
                if (tool.usageCount >= tool.lifetime) {
                    alert(`[알림] 설비 "${selectedEq.assetName}"의 툴 "${tool.name}"의 수명이 다했습니다. 교체가 필요합니다.`);
                }
            }
        }

        function deleteTool(eqId, toolId) {
            if (!confirm('정말로 이 툴을 삭제하시겠습니까?')) return;
            const selectedEq = equipments.find(eq => eq.id === eqId);
            const toolIndex = selectedEq.tools.findIndex(t => t.id === toolId);
            if (toolIndex > -1) {
                const toolName = selectedEq.tools[toolIndex].name;
                selectedEq.tools.splice(toolIndex, 1);
                saveData();
                renderToolList();
                addLog('툴 삭제', selectedEq.assetName, `툴 "${toolName}" 삭제`);
            }
        }

        // 설비 이력 카드 렌더링
        function showEquipmentHistory() {
            const searchInput = document.getElementById('history-equipment-search');
            const selectedId = searchInput.dataset.selectedId;

            if (!selectedId) {
                alert('설비를 먼저 선택해주세요.');
                return;
            }

            const eq = equipments.find(e => e.id === selectedId);
            const container = document.getElementById('history-card-container');
            if (!eq) {
                container.innerHTML = `<p>선택된 설비가 없습니다.</p>`;
                return;
            }
            
            const allHistory = [
                ...(eq.faultHistory || []).map(f => ({ ...f, type: f.type, description: f.description, partsUsed: f.partsUsed, isFault: true })),
                ...(eq.pmHistory || []).map(p => ({ ...p, type: 'pm', description: p.description, partsUsed: p.partsUsed, isPm: true })),
                ...(eq.calibrationHistory || []).map(c => ({ ...c, type: 'calibration', description: c.description, partsUsed: c.partsUsed, isCalibration: true }))
            ].sort((a, b) => new Date(b.occurTime || b.date) - new Date(a.occurTime || a.date));


            const allHistoryHtml = allHistory.map(h => `
                <tr>
                    <td><span class="status-badge ${getMaintenanceBadgeClass(h.type)}">${getMaintenanceTypeText(h.type)}</span></td>
                    <td>${h.occurTime ? h.occurTime.replace('T', ' ') : h.date}</td>
                    <td>${h.endTime ? h.endTime.replace('T', ' ') : ''}</td>
                    <td>${h.reporter}</td>
                    <td>${h.description}</td>
                    <td>${h.partsUsed || '없음'}</td>
                </tr>
            `).join('');


            const historyCardHtml = `
                <div class="history-card">
                    <div class="history-card-header">
                        <div>
                            <h2 class="history-card-title">${eq.assetName}</h2>
                            <p class="history-card-subtitle">${eq.assetCode}</p>
                        </div>
                        <span class="status-badge ${getStatusBadgeClass(eq.operatingStatus)}">
                            ${getEquipmentStatusText(eq.operatingStatus)}
                        </span>
                    </div>
                    <div class="history-card-content">
                        <div class="equipment-details">
                            <div class="equipment-details-grid">
                                <div class="detail-row"><div class="detail-label">S/N</div><div class="detail-value">${eq.serialNumber}</div></div>
                                <div class="detail-row"><div class="detail-label">모델명</div><div class="detail-value">${eq.mcModel}</div></div>
                                <div class="detail-row"><div class="detail-label">설비 제조사</div><div class="detail-value">${eq.manufacturer || 'N/A'}</div></div>
                                <div class="detail-row"><div class="detail-label">공정</div><div class="detail-value">${eq.process || 'N/A'}</div></div>
                                <div class="detail-row"><div class="detail-label">생산 모델</div><div class="detail-value">${eq.productModel}</div></div>
                                <div class="detail-row"><div class="detail-label">설치 장소</div><div class="detail-value">${eq.factory} ${eq.floor}</div></div>
                                <div class="detail-row"><div class="detail-label">설치일</div><div class="detail-value">${eq.installDate}</div></div>
                                <div class="detail-row"><div class="detail-label">담당자</div><div class="detail-value">${eq.operator}</div></div>
                            </div>
                        </div>
                        <div class="equipment-image-section">
                            <p style="font-weight: 500; font-size: 0.875rem;">설비 사진</p>
                            <div class="equipment-image-container">
                                <div class="equipment-image">
                                    ${eq.frontImage ? `<img src="${eq.frontImage}" alt="정면 사진">` : '정면 사진 없음'}
                                </div>
                                <div class="equipment-image">
                                    ${eq.nameplateImage ? `<img src="${eq.nameplateImage}" alt="명판 사진">` : '명판 사진 없음'}
                                </div>
                            </div>
                            <div class="qr-code-section">
                                <p style="font-weight: 500; margin-bottom: 0.5rem;">QR Code</p>
                                <div class="qr-code">QR CODE</div>
                                <div class="asset-info">
                                    <div><strong>Asset Code:</strong> ${eq.assetCode}</div>
                                    <div><strong>S/N:</strong> ${eq.serialNumber}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="change-history-section">
                        <div class="change-history-header">유지보수 이력</div>
                        <div style="overflow-x: auto;">
                            <table class="change-history-table">
                                <thead>
                                    <tr>
                                        <th>유형</th>
                                        <th>시작 시간</th>
                                        <th>종료 시간</th>
                                        <th>담당자</th>
                                        <th>내용</th>
                                        <th>사용한 부품</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allHistoryHtml || `<tr><td colspan="6" style="text-align: center; color: #6b7280;">이력이 없습니다.</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = historyCardHtml;
            lucide.createIcons();
        }
        
        function showEquipmentHistoryById(id) {
            const eq = equipments.find(e => e.id === id);
            document.getElementById('history-equipment-search').value = `${eq.assetName} (${eq.assetCode})`;
            document.getElementById('history-equipment-search').dataset.selectedId = eq.id;
            document.getElementById('history-equipment-select').value = `${eq.assetName} (${eq.assetCode})`;
            showTab('history');
            showEquipmentHistory();
        }

        // 스페어 파트 마스터 등록 관련 함수
        document.getElementById('spare-part-master-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const isEditMode = this.dataset.editId;
            const newMasterPart = {
                id: isEditMode || 'spm' + Date.now(),
                process: document.getElementById('part-master-process').value,
                partName: document.getElementById('part-master-name').value,
                partSpec: document.getElementById('part-master-spec').value,
                manufacturer: document.getElementById('part-master-manufacturer').value,
                usedEquipment: document.getElementById('part-master-equipment').value
            };
            
            if (isEditMode) {
                const index = sparePartMasters.findIndex(p => p.id === isEditMode);
                sparePartMasters[index] = newMasterPart;
                addLog('파트 마스터 수정', newMasterPart.partName, '파트 기초 정보가 수정되었습니다.');
            } else {
                sparePartMasters.push(newMasterPart);
                addLog('파트 마스터 등록', newMasterPart.partName, '새로운 파트 기초 정보가 등록되었습니다.');
            }

            saveData();
            renderSparePartMasters();
            resetPartMasterForm();
        });
        
        function renderSparePartMasters() {
            const tableBody = document.getElementById('spare-part-master-table-body');
            tableBody.innerHTML = sparePartMasters.map(part => `
                <tr onclick="editSparePartMaster('${part.id}')">
                    <td>${part.process}</td>
                    <td>${part.partName}</td>
                    <td>${part.partSpec || 'N/A'}</td>
                    <td>${part.manufacturer || 'N/A'}</td>
                    <td>${part.usedEquipment || 'N/A'}</td>
                    <td class="action-icons">
                        <button class="action-btn delete" onclick="event.stopPropagation(); deleteSparePartMaster('${part.id}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function populateEquipmentSelect() {
            const select = document.getElementById('part-master-equipment');
            select.innerHTML = `<option value="">-- 설비 선택 --</option>`;
            equipments.forEach(eq => {
                const option = document.createElement('option');
                option.value = eq.assetCode;
                option.textContent = `${eq.assetName} (${eq.assetCode})`;
                select.appendChild(option);
            });
        }
        
        function editSparePartMaster(id) {
            const part = sparePartMasters.find(p => p.id === id);
            if (!part) return;

            document.getElementById('part-master-form-title').textContent = '스페어 파트 기초 정보 수정';
            document.getElementById('part-master-submit-btn').innerHTML = `<i data-lucide="save" style="width: 1rem; height: 1rem;"></i><span>수정</span>`;
            document.getElementById('spare-part-master-form').dataset.editId = id;
            
            document.getElementById('part-master-process').value = part.process;
            document.getElementById('part-master-name').value = part.partName;
            document.getElementById('part-master-spec').value = part.partSpec;
            document.getElementById('part-master-manufacturer').value = part.manufacturer;
            document.getElementById('part-master-equipment').value = part.usedEquipment;
            lucide.createIcons();
        }

        function deleteSparePartMaster(id) {
            if (confirm('정말로 이 파트의 기초 정보를 삭제하시겠습니까?')) {
                const part = sparePartMasters.find(p => p.id === id);
                sparePartMasters = sparePartMasters.filter(p => p.id !== id);
                saveData();
                addLog('파트 마스터 삭제', part.partName, '파트 기초 정보가 삭제되었습니다.');
                renderSparePartMasters();
            }
        }

        function resetPartMasterForm() {
            document.getElementById('spare-part-master-form').reset();
            document.getElementById('part-master-form-title').textContent = '스페어 파트 기초 정보 등록';
            document.getElementById('part-master-submit-btn').innerHTML = `<i data-lucide="save" style="width: 1rem; height: 1rem;"></i><span>등록</span>`;
            delete document.getElementById('spare-part-master-form').dataset.editId;
            lucide.createIcons();
        }

        // 스페어 파트 재고 관리 관련 함수
        function renderSparePartsList() {
            const searchTerm = document.getElementById('part-search-input').value.toLowerCase();
            const filteredParts = spareParts.filter(part =>
                part.partName.toLowerCase().includes(searchTerm) || part.partCode.toLowerCase().includes(searchTerm)
            );

            const tableBody = document.getElementById('spare-part-table-body');
            tableBody.innerHTML = filteredParts.map(part => {
                const stockStatus = part.currentStock < part.minStock ? '재고 부족' : (part.currentStock > part.maxStock ? '재고 과다' : '정상');
                const statusClass = part.currentStock < part.minStock ? 'status-stopped' : (part.currentStock > part.maxStock ? 'status-maintenance' : 'status-active');
                return `
                    <tr>
                        <td>${part.partName}</td>
                        <td>${part.partCode}</td>
                        <td>${part.process}</td>
                        <td>${part.currentStock}</td>
                        <td>${part.minStock}</td>
                        <td>${part.maxStock}</td>
                        <td><span class="status-badge ${statusClass}">${stockStatus}</span></td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        function showPartModal(type) {
            const modal = document.getElementById('part-modal');
            document.getElementById('part-modal-title').textContent = type === 'inbound' ? '스페어 파트 입고 등록' : '스페어 파트 출고 등록';
            document.getElementById('transaction-type').value = type;
            document.getElementById('used-equipment-group').style.display = type === 'outbound' ? 'flex' : 'none';
            modal.style.display = 'flex';
            
            // 파트 드롭다운 업데이트
            const partSelect = document.getElementById('part-id');
            partSelect.innerHTML = `<option value="">-- 파트 선택 --</option>` + spareParts.map(p => 
                `<option value="${p.partCode}">${p.partCode} - ${p.partName}</option>`).join('');

            // 공정 드롭다운 초기화
            document.getElementById('part-process').value = '';
            // 사용 설비 드롭다운 초기화
            document.getElementById('used-equipment').innerHTML = `<option value="">-- 설비 선택 --</option>`;
        }

        function closePartModal() {
            document.getElementById('part-modal').style.display = 'none';
            document.getElementById('part-transaction-form').reset();
            document.getElementById('part-name').value = '';
        }
        
        function updatePartName() {
            const partCode = document.getElementById('part-id').value;
            const part = spareParts.find(p => p.partCode === partCode);
            document.getElementById('part-name').value = part ? part.partName : '';
        }

        function filterEquipmentsByProcess() {
            const selectedProcess = document.getElementById('part-process').value;
            const equipmentSelect = document.getElementById('used-equipment');
            equipmentSelect.innerHTML = `<option value="">-- 설비 선택 --</option>`;

            if (selectedProcess) {
                const filteredEquipments = equipments.filter(eq => eq.process === selectedProcess);
                filteredEquipments.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.assetName} (${eq.assetCode})`;
                    equipmentSelect.appendChild(option);
                });
            }
        }

        document.getElementById('part-transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const type = document.getElementById('transaction-type').value;
            const partCode = document.getElementById('part-id').value;
            const quantity = parseInt(document.getElementById('part-quantity').value);
            const process = document.getElementById('part-process').value;
            const usedEquipmentId = document.getElementById('used-equipment').value;
            const operator = document.getElementById('part-operator').value || currentUser;

            const part = spareParts.find(p => p.partCode === partCode);
            if (!part) {
                alert('유효하지 않은 파트 코드입니다.');
                return;
            }

            if (type === 'inbound') {
                part.currentStock += quantity;
                addLog('파트 입고', part.partName, `${quantity}개 입고 (현재 재고: ${part.currentStock})`);
            } else if (type === 'outbound') {
                if (part.currentStock < quantity) {
                    alert('재고가 부족합니다.');
                    return;
                }
                part.currentStock -= quantity;
                addLog('파트 출고', part.partName, `${quantity}개 출고 (현재 재고: ${part.currentStock})`);
                
                // 설비 이력에 추가 (고장, PM, Calibration 등)
                if (usedEquipmentId) {
                    const equipment = equipments.find(eq => eq.id === usedEquipmentId);
                    if (equipment) {
                        const newHistory = {
                            id: 'part-use-' + Date.now(),
                            occurTime: new Date().toISOString(),
                            endTime: new Date().toISOString(),
                            reporter: operator,
                            type: '부품 교체',
                            description: `${part.partName} ${quantity}개 교체`,
                            partsUsed: `${part.partName} ${quantity}개`,
                            equipmentId: usedEquipmentId
                        };
                        // 현재는 고장 히스토리에만 추가, 필요시 PM/Calibration 이력에도 연동 가능
                        if (!equipment.faultHistory) equipment.faultHistory = [];
                        equipment.faultHistory.push(newHistory);
                        addLog('설비 히스토리 업데이트', equipment.assetName, `${part.partName} ${quantity}개 부품 사용 기록 추가`);
                    }
                }
            }

            saveData();
            renderSparePartsList();
            closePartModal();
        });


        // ==================== 기존 기능 함수 (수정) ====================
        
        // 설비 등록/수정 폼 관련
        document.getElementById('equipment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const isEditMode = this.dataset.editId;
            const equipment = isEditMode ? equipments.find(eq => eq.id === isEditMode) : {};

            const assetCode = document.getElementById('assetCode').value;
            const serialNumber = document.getElementById('serialNumber').value;
            const existingAssetCode = equipments.find(e => e.assetCode === assetCode && e.id !== isEditMode);
            const existingSerialNumber = equipments.find(e => e.serialNumber === serialNumber && e.id !== isEditMode);

            if (existingAssetCode) {
                document.getElementById('assetCode-alert').classList.remove('hidden');
                return;
            } else {
                document.getElementById('assetCode-alert').classList.add('hidden');
            }

            if (existingSerialNumber) {
                document.getElementById('serialNumber-alert').classList.remove('hidden');
                return;
            } else {
                document.getElementById('serialNumber-alert').classList.add('hidden');
            }

            const newEquipment = {
                id: isEditMode || 'eq' + Date.now(),
                assetName: document.getElementById('assetName').value,
                assetCode: assetCode,
                serialNumber: serialNumber,
                mcModel: document.getElementById('mcModel').value,
                manufacturer: document.getElementById('manufacturer').value,
                process: document.getElementById('process').value,
                productModel: document.getElementById('productModel').value,
                factory: document.getElementById('factory').value,
                floor: document.getElementById('floor').value,
                installDate: document.getElementById('installDate').value,
                operatingStatus: document.getElementById('operatingStatus').value,
                operator: document.getElementById('operator').value,
                frontImage: equipment.frontImage || null,
                nameplateImage: equipment.nameplateImage || null,
                pmHistory: equipment.pmHistory || [],
                faultHistory: equipment.faultHistory || [],
                tools: equipment.tools || [],
            };

            if (isEditMode) {
                const index = equipments.findIndex(e => e.id === isEditMode);
                equipments[index] = newEquipment;
                addLog('설비 수정', newEquipment.assetName, `정보가 수정되었습니다.`);
            } else {
                equipments.push(newEquipment);
                addLog('설비 등록', newEquipment.assetName, `새로운 설비가 등록되었습니다.`);
            }

            saveData();
            this.reset();
            document.getElementById('form-submit-text').textContent = '등록';
            document.getElementById('form-title').textContent = '새 설비 등록';
            delete this.dataset.editId;
            renderEquipmentList();
            renderDashboard();
            showTab('list');
        });

        document.getElementById('frontImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                document.getElementById('front-image-preview').innerHTML = '';
                document.getElementById('front-image-preview').appendChild(img);
                if (this.form.dataset.editId) {
                    const eq = equipments.find(e => e.id === this.form.dataset.editId);
                    eq.frontImage = event.target.result;
                    saveData();
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('nameplateImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                document.getElementById('nameplate-image-preview').innerHTML = '';
                document.getElementById('nameplate-image-preview').appendChild(img);
                if (this.form.dataset.editId) {
                    const eq = equipments.find(e => e.id === this.form.dataset.editId);
                    eq.nameplateImage = event.target.result;
                    saveData();
                }
            };
            reader.readAsDataURL(file);
        });

        function editEquipment(id) {
            const equipment = equipments.find(eq => eq.id === id);
            if (!equipment) return;

            document.getElementById('form-title').textContent = '설비 정보 수정';
            document.getElementById('form-submit-text').textContent = '수정';
            document.getElementById('equipment-form').dataset.editId = id;

            document.getElementById('assetName').value = equipment.assetName;
            document.getElementById('assetCode').value = equipment.assetCode;
            document.getElementById('serialNumber').value = equipment.serialNumber;
            document.getElementById('mcModel').value = equipment.mcModel;
            document.getElementById('manufacturer').value = equipment.manufacturer;
            document.getElementById('process').value = equipment.process;
            document.getElementById('productModel').value = equipment.productModel;
            document.getElementById('factory').value = equipment.factory;
            document.getElementById('floor').value = equipment.floor;
            document.getElementById('installDate').value = equipment.installDate;
            document.getElementById('operatingStatus').value = equipment.operatingStatus;
            document.getElementById('operator').value = equipment.operator;
            
            const frontPreview = document.getElementById('front-image-preview');
            frontPreview.innerHTML = equipment.frontImage ? `<img src="${equipment.frontImage}" alt="정면 사진">` : '정면 사진';
            const nameplatePreview = document.getElementById('nameplate-image-preview');
            nameplatePreview.innerHTML = equipment.nameplateImage ? `<img src="${equipment.nameplateImage}" alt="명판 사진">` : '명판 사진';

            showTab('register');
        }

        function deleteEquipment(id) {
            if (confirm('정말로 이 설비를 삭제하시겠습니까?')) {
                const eq = equipments.find(e => e.id === id);
                equipments = equipments.filter(eq => eq.id !== id);
                saveData();
                addLog('설비 삭제', eq.assetName, `설비가 삭제되었습니다.`);
                renderEquipmentList();
                renderDashboard();
            }
        }
        
        function changeUser(user) {
            currentUser = user;
            alert(`${user}로 로그인되었습니다.`);
        }

        // 로그 렌더링
        function renderLogs() {
            const logTableBody = document.getElementById('log-table-body');
            logTableBody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.timestamp}</td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.target}</td>
                    <td>${log.details}</td>
                </tr>
            `).join('');
        }
        
        // 검색 기능
        function setupEventListeners() {
            document.getElementById('list-search-input').addEventListener('keyup', renderEquipmentList);
        }
        
        // 고장 현황
        function searchFaultHistoryByDate() {
            const startDate = document.getElementById('fault-start-date').value;
            const endDate = document.getElementById('fault-end-date').value;
            
            let allFaults = [];
            equipments.forEach(eq => {
                eq.faultHistory.forEach(fault => {
                    allFaults.push({ ...fault, equipmentName: eq.assetName, assetCode: eq.assetCode });
                });
            });
            
            const filteredFaults = allFaults.filter(f => {
                const faultDate = f.occurTime.split('T')[0];
                return (!startDate || faultDate >= startDate) && (!endDate || faultDate <= endDate);
            }).sort((a, b) => new Date(b.occurTime) - new Date(a.occurTime));
            
            const tableBody = document.getElementById('fault-table-body');
            tableBody.innerHTML = filteredFaults.map(f => `
                <tr>
                    <td>${f.equipmentName} (${f.assetCode})</td>
                    <td>${f.occurTime.replace('T', ' ')}</td>
                    <td>${f.endTime.replace('T', ' ')}</td>
                    <td>${f.reporter}</td>
                    <td>${f.description}</td>
                    <td>${f.type}</td>
                    <td>${f.partsUsed || '없음'}</td>
                </tr>
            `).join('');
            
            document.getElementById('fault-list-count').textContent = filteredFaults.length;
        }
        
        // 고장 히스토리 등록
        document.getElementById('fault-history-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const equipmentId = document.getElementById('fault-equipment-search').dataset.selectedId;
            if (!equipmentId) {
                alert('설비를 먼저 선택해주세요.');
                return;
            }

            const maintenanceType = document.getElementById('maintenance-type').value;
            const faultData = {
                id: maintenanceType + '-' + Date.now(),
                type: maintenanceType,
                occurTime: document.getElementById('fault-occur-time').value,
                endTime: document.getElementById('fault-end-time').value,
                reporter: document.getElementById('fault-reporter').value,
                description: document.getElementById('fault-description').value,
                partsUsed: document.getElementById('fault-parts-used').value
            };

            const equipment = equipments.find(eq => eq.id === equipmentId);
            
            if (maintenanceType === 'fault') {
                if (!equipment.faultHistory) equipment.faultHistory = [];
                equipment.faultHistory.push(faultData);
            } else if (maintenanceType === 'pm') {
                if (!equipment.pmHistory) equipment.pmHistory = [];
                equipment.pmHistory.push(faultData);
            } else if (maintenanceType === 'calibration') {
                if (!equipment.calibrationHistory) equipment.calibrationHistory = [];
                equipment.calibrationHistory.push(faultData);
            }

            saveData();
            addLog('유지보수 히스토리 등록', equipment.assetName, `${getMaintenanceTypeText(maintenanceType)} 히스토리 등록`);
            alert('유지보수 히스토리가 성공적으로 등록되었습니다.');
            this.reset();
        });

        // 설비 검색 자동완성
        function setupSearchInput(inputId, resultsId, selectInputId) {
            const searchInput = document.getElementById(inputId);
            const resultsList = document.getElementById(resultsId);
            const selectInput = document.getElementById(selectInputId);

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                resultsList.innerHTML = '';
                if (query.length < 2) {
                    resultsList.classList.add('hidden');
                    return;
                }
                
                const filtered = equipments.filter(eq => 
                    eq.assetName.toLowerCase().includes(query) || eq.assetCode.toLowerCase().includes(query)
                );
                
                if (filtered.length > 0) {
                    filtered.forEach(eq => {
                        const li = document.createElement('li');
                        li.textContent = `${eq.assetName} (${eq.assetCode})`;
                        li.className = 'search-results-item';
                        li.onclick = () => {
                            selectInput.value = li.textContent;
                            searchInput.value = li.textContent;
                            searchInput.dataset.selectedId = eq.id;
                            resultsList.classList.add('hidden');
                        };
                        resultsList.appendChild(li);
                    });
                    resultsList.classList.remove('hidden');
                } else {
                    resultsList.classList.add('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                if (!resultsList.contains(e.target) && e.target !== searchInput) {
                    resultsList.classList.add('hidden');
                }
            });
        }
        setupSearchInput('history-equipment-search', 'history-equipment-search-results', 'history-equipment-select');
        setupSearchInput('fault-equipment-search', 'fault-equipment-search-results', 'fault-equipment-select');
        
        // 일괄 등록
        function downloadTemplate() {
            const header = [
                'assetName', 'assetCode', 'serialNumber', 'mcModel', 'manufacturer', 'process',
                'productModel', 'factory', 'floor', 'installDate', 'operatingStatus', 'operator'
            ];
            const ws = XLSX.utils.aoa_to_sheet([header]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "설비등록");
            XLSX.writeFile(wb, "설비등록_템플릿.xlsx");
        }
        
        function processBulkUpload() {
            const tableBody = document.getElementById('preview-body');
            const newEquipments = [];
            let hasError = false;

            for (const row of tableBody.children) {
                const cells = row.querySelectorAll('td');
                const newEq = {};
                const keys = [
                    'assetName', 'assetCode', 'serialNumber', 'mcModel', 'manufacturer', 'process',
                    'productModel', 'factory', 'floor', 'installDate', 'operatingStatus', 'operator'
                ];

                keys.forEach((key, i) => {
                    newEq[key] = cells[i].textContent;
                });
                
                // 유효성 검사
                if (!newEq.assetName || !newEq.assetCode || !newEq.serialNumber || !newEq.factory || !newEq.floor || !newEq.installDate || !newEq.operatingStatus || !newEq.process) {
                    alert('필수 항목이 누락된 데이터가 있습니다. 등록을 취소합니다.');
                    hasError = true;
                    break;
                }
                
                newEq.id = 'eq' + Date.now() + Math.random();
                newEq.pmHistory = [];
                newEq.faultHistory = [];
                newEq.tools = [];
                
                newEquipments.push(newEq);
            }
            
            if (hasError) return;
            
            equipments.push(...newEquipments);
            saveData();
            addLog('일괄 등록', `총 ${newEquipments.length}개 설비`, '엑셀 파일을 통한 설비 일괄 등록');
            alert(`${newEquipments.length}개의 설비가 성공적으로 등록되었습니다.`);
            showTab('list');
        }

        function handleFile(e) {
            const files = e.target.files || e.dataTransfer.files;
            if (files.length === 0) return;
            const file = files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (json.length > 1) {
                    const header = json[0];
                    const rows = json.slice(1);
                    const previewHeader = document.getElementById('preview-header');
                    const previewBody = document.getElementById('preview-body');
                    
                    previewHeader.innerHTML = `<tr>${header.map(h => `<th>${h}</th>`).join('')}</tr>`;
                    previewBody.innerHTML = rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
                    
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('bulk-upload-actions').classList.remove('hidden');
                } else {
                    document.getElementById('upload-message').className = 'upload-error';
                    document.getElementById('upload-message').textContent = '파일에 데이터가 없습니다.';
                    document.getElementById('upload-message').classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        document.getElementById('excel-file-input').addEventListener('change', handleFile, false);
        const fileUploadArea = document.getElementById('file-upload-area');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => fileUploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => fileUploadArea.classList.remove('dragover'), false);
        });

        fileUploadArea.addEventListener('drop', handleFile, false);
        fileUploadArea.addEventListener('click', () => {
            document.getElementById('excel-file-input').click();
        });

    </script>
</body>
</html>